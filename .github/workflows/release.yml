# .github/workflows/release.yml

name: Build, Test, Publish & Generate AI Release Notes

on:
  push:
    tags:
      - "v*" # ä»…åœ¨æ¨é€ v* æ ¼å¼çš„æ ‡ç­¾æ—¶è§¦å‘ (e.g., v1.0.0, v1.2.3)

# æƒé™è®¾ç½®ï¼š
# contents: write - å…è®¸åˆ›å»º GitHub Release
# models: read   - å…è®¸è°ƒç”¨ GitHub Models AI API
permissions:
  contents: write
  models: read

jobs:
  build-test-publish-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          # æ‹‰å–æ‰€æœ‰å†å²è®°å½•ï¼Œä»¥ä¾¿èƒ½æ¯”è¾ƒä¸åŒ tag ä¹‹é—´çš„å·®å¼‚
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"

      # æ„å»ºã€æµ‹è¯•ã€æ‰“åŒ… ...
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -e .

      - name: Build package
        run: |
          pip install setuptools wheel
          python setup.py sdist bdist_wheel

      # ------------------------------------------------------------------
      # AI ç”Ÿæˆ Release Notes çš„æ–°æ­¥éª¤
      # ------------------------------------------------------------------

      - name: 1. Get commit history for AI prompt
        id: get_changelog
        run: |
          # è·å–å½“å‰æ ‡ç­¾
          CURRENT_TAG=${{ github.ref_name }}
          echo "Current tag is: $CURRENT_TAG"

          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          # git describe --tags --abbrev=0 HEAD~1 åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¸å‡†ç¡®ï¼Œæ”¹ç”¨ä¸‹é¢çš„æ–¹æ³•
          PREVIOUS_TAG=$(git tag --sort=-v:refname | head -n 2 | tail -n 1)

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found. Using all commits."
            # å¦‚æœæ˜¯ç¬¬ä¸€ä¸ª tagï¼Œåˆ™è·å–ä»é¡¹ç›®å¼€å§‹åˆ°å½“å‰ tag çš„æ‰€æœ‰ commit
            COMMIT_LOG=$(git log --pretty=format:"- %s")
          else
            echo "Previous tag is: $PREVIOUS_TAG"
            # è·å–ä¸¤ä¸ª tag ä¹‹é—´çš„ commit log
            COMMIT_LOG=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..$CURRENT_TAG)
          fi

          # å°†å¤šè¡Œ commit log è½¬æ¢ä¸ºå•è¡Œå­—ç¬¦ä¸²ï¼Œä»¥ä¾¿åœ¨ JSON ä¸­ä¼ é€’
          # ä½¿ç”¨ EOF æ¥å¤„ç†å¤šè¡Œå­—ç¬¦ä¸²ï¼Œé¿å…è½¬ä¹‰é—®é¢˜
          CHANGELOG_CONTENT=$(cat <<EOF
          $COMMIT_LOG
          EOF
          )

          # -----------------------------------------------------------------
          # æ–°å¢ï¼šä¸“é—¨ç”¨äºè°ƒè¯•ï¼Œæ‰“å°å˜é‡å†…å®¹åˆ°æ—¥å¿—
          echo "--- Content being set for the next step ---"
          echo "$CHANGELOG_CONTENT"
          echo "-------------------------------------------"
          # -----------------------------------------------------------------

          # å°†å¤„ç†å¥½çš„ changelog è®¾ç½®ä¸º step çš„è¾“å‡º
          echo "changelog_for_ai<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 2. Call AI to generate release notes
        id: ai_release_notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHANGELOG_DATA: ${{ steps.get_changelog.outputs.changelog_for_ai }}
        run: |
          # å®‰è£… jq ç”¨äºè§£æ JSON å“åº”
          sudo apt-get update && sudo apt-get install -y jq

          # æ„å»º AI Prompt
          # æŒ‡ç¤º AI å°† commit log æ€»ç»“å¹¶åˆ†ç±»ä¸ºç‰ˆæœ¬è¯´æ˜
          PROMPT="Based on the following list of commit messages, please generate a user-friendly changelog for a new release. Categorize the changes into 'ğŸš€ New Features', 'ğŸ› Bug Fixes', and 'âš™ï¸ Other Changes'. Use markdown bullet points for each item. If a category is empty, please omit it from the output. Here are the commits:"

          # æ„å»º JSON è¯·æ±‚ä½“
          # ä½¿ç”¨ jq æ¥å®‰å…¨åœ°æ„å»º JSONï¼Œé¿å…æ‰‹åŠ¨æ‹¼æ¥å­—ç¬¦ä¸²çš„å„ç§é—®é¢˜
          JSON_PAYLOAD=$(jq -n \
            --arg prompt "$PROMPT" \
            --arg commits "$CHANGELOG_DATA" \
            '{
              "model": "openai/gpt-4o",
              "messages": [
                {
                  "role": "system",
                  "content": $prompt
                },
                {
                  "role": "user",
                  "content": $commits
                }
              ]
            }')

          echo "Sending prompt to AI model..."

          # è°ƒç”¨ GitHub Models API
          AI_RESPONSE=$(curl -s "https://models.github.ai/inference/chat/completions" \
               -H "Content-Type: application/json" \
               -H "Authorization: Bearer $GITHUB_TOKEN" \
               -d "$JSON_PAYLOAD")

          # =======================================================
          # === æ–°å¢çš„è°ƒè¯•æ­¥éª¤ï¼šæ‰“å°ä» API æ”¶åˆ°çš„åŸå§‹å“åº” ===
          echo "--- Raw AI Response Start ---"
          echo "$AI_RESPONSE"
          echo "--- Raw AI Response End ---"
          # =======================================================

          # ä» AI å“åº”ä¸­æå–å†…å®¹ï¼Œå¹¶è®¾ç½®ä¸º step çš„è¾“å‡º
          RELEASE_BODY=$(echo "$AI_RESPONSE" | jq -r '.choices[0].message.content')

          echo "Generated Release Notes:"
          echo "$RELEASE_BODY"

          # å°†æœ€ç»ˆçš„ release body è®¾ç½®ä¸º step çš„è¾“å‡ºï¼Œä»¥ä¾¿åç»­æ­¥éª¤ä½¿ç”¨
          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------
      # å‘å¸ƒåˆ° PyPI å’Œ GitHub Release çš„æ­¥éª¤
      # ------------------------------------------------------------------

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          pip install twine
          twine upload dist/*

      - name: Create GitHub Release with AI Notes
        uses: softprops/action-gh-release@v1
        with:
          # ä½¿ç”¨ä¸Šä¸€æ­¥ AI ç”Ÿæˆçš„å†…å®¹ä½œä¸º Release çš„ body
          body: ${{ steps.ai_release_notes.outputs.release_body }}
          # ä¸Šä¼ æ‰“åŒ…å¥½çš„æ–‡ä»¶
          files: dist/*
